<?php
/**
 * Konfigurasi Database - TEMPLATE
 * Risk Assessment Objek Wisata
 * Support untuk Railway.app, Render.com, dan environment variables
 * 
 * INSTRUKSI:
 * 1. Copy file ini menjadi database.php
 * 2. Untuk Railway/Render: Aplikasi akan otomatis membaca dari environment variables
 * 3. Untuk lokal: Isi dengan kredensial database Anda
 */

// Cek Railway MySQL variables (prioritas pertama)
if (getenv('MYSQL_HOST')) {
    // Railway MySQL format
    define('DB_HOST', getenv('MYSQL_HOST'));
    define('DB_PORT', getenv('MYSQL_PORT') ?: 3306);
    define('DB_USER', getenv('MYSQL_USER'));
    define('DB_PASS', getenv('MYSQL_PASSWORD'));
    define('DB_NAME', getenv('MYSQL_DATABASE'));
    define('DB_TYPE', 'mysql');
} elseif (getenv('PGHOST') || getenv('POSTGRES_HOST')) {
    // Railway PostgreSQL format (alternative)
    define('DB_HOST', getenv('PGHOST') ?: getenv('POSTGRES_HOST') ?: 'localhost');
    define('DB_PORT', getenv('PGPORT') ?: getenv('POSTGRES_PORT') ?: 5432);
    define('DB_USER', getenv('PGUSER') ?: getenv('POSTGRES_USER') ?: 'postgres');
    define('DB_PASS', getenv('PGPASSWORD') ?: getenv('POSTGRES_PASSWORD') ?: '');
    define('DB_NAME', getenv('PGDATABASE') ?: getenv('POSTGRES_DB') ?: 'postgres');
    define('DB_TYPE', 'postgresql');
} elseif (getenv('DATABASE_URL')) {
    // Parse DATABASE_URL dari Render (format: postgresql://user:pass@host:port/dbname)
    $url = parse_url(getenv('DATABASE_URL'));
    
    define('DB_HOST', $url['host'] ?? 'localhost');
    define('DB_PORT', $url['port'] ?? 5432); // PostgreSQL default port
    define('DB_USER', $url['user'] ?? '');
    define('DB_PASS', $url['pass'] ?? '');
    define('DB_NAME', ltrim($url['path'] ?? '', '/'));
    define('DB_TYPE', 'postgresql'); // Untuk PostgreSQL di Render
} elseif (getenv('DB_HOST')) {
    // Menggunakan environment variables individual
    define('DB_HOST', getenv('DB_HOST') ?: 'localhost');
    define('DB_PORT', getenv('DB_PORT') ?: 3306); // MySQL default port
    define('DB_USER', getenv('DB_USER') ?: 'root');
    define('DB_PASS', getenv('DB_PASS') ?: '');
    define('DB_NAME', getenv('DB_NAME') ?: 'risk_assessment_db');
    define('DB_TYPE', getenv('DB_TYPE') ?: 'mysql');
    } else {
        // Konfigurasi lokal/default
        // Jika di Railway tapi tidak ada environment variables, tampilkan instruksi setup
        if (getenv('RAILWAY_ENVIRONMENT') || getenv('RAILWAY_PROJECT_ID') || file_exists('/.dockerenv')) {
            // Kemungkinan di Railway tapi database belum di-setup
            $setup_url = (defined('BASE_URL') ? BASE_URL : '/') . 'pages/setup_railway.php';
            die("
                <div style='font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 50px auto; border: 2px solid #dc3545; border-radius: 8px; background: #fff;'>
                    <h2 style='color: #dc3545;'>âš ï¸ Database Belum Dikonfigurasi</h2>
                    <p>Environment variables untuk database tidak ditemukan. Aplikasi ini memerlukan database untuk berfungsi.</p>
                    <h3>Langkah Setup:</h3>
                    <ol>
                        <li>Buka <strong>Railway Dashboard</strong> â†’ Project Anda</li>
                        <li>Klik <strong>\"New +\"</strong> â†’ <strong>\"Database\"</strong> â†’ <strong>\"Add MySQL\"</strong></li>
                        <li>Railway akan otomatis link database ke web service</li>
                        <li>Set environment variable <strong>BASE_URL</strong> di Web Service â†’ Variables</li>
                        <li>Restart web service (Redeploy)</li>
                    </ol>
                    <p><strong>Atau</strong> klik link berikut untuk instruksi lengkap:</p>
                    <a href='{$setup_url}' style='display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; margin-top: 10px;'>ğŸ“– Lihat Instruksi Setup</a>
                    <hr style='margin: 20px 0;'>
                    <p><small>Jika Anda menggunakan database lokal, pastikan environment variables sudah di-set dengan benar.</small></p>
                </div>
            ");
        }
        
        define('DB_HOST', 'localhost');
        define('DB_USER', 'root');
        define('DB_PASS', '');
        define('DB_NAME', 'risk_assessment_db');
        define('DB_PORT', 3306);
        define('DB_TYPE', 'mysql');
    }

// Koneksi database
function getDBConnection() {
    // Cek apakah database sudah didefinisikan
    if (!defined('DB_HOST') || !defined('DB_USER') || !defined('DB_NAME')) {
        die("Error: Konfigurasi database belum lengkap. Pastikan DB_HOST, DB_USER, dan DB_NAME sudah didefinisikan.");
    }
    
    // Untuk PostgreSQL (Render), gunakan PDO
    // Untuk MySQL, gunakan mysqli
    $db_type = defined('DB_TYPE') ? DB_TYPE : 'mysql';
    
    if ($db_type === 'postgresql') {
        // PostgreSQL connection (untuk Railway/Render)
        try {
            // Check if PDO PostgreSQL extension is available
            if (!extension_loaded('pdo_pgsql')) {
                die("Error: PDO PostgreSQL extension (pdo_pgsql) tidak tersedia. Silakan install extension ini.");
            }
            
            $dsn = "pgsql:host=" . DB_HOST . ";port=" . (defined('DB_PORT') ? DB_PORT : 5432) . ";dbname=" . DB_NAME;
            $conn = new PDO($dsn, DB_USER, DB_PASS);
            $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            return $conn;
        } catch (PDOException $e) {
            die("Koneksi PostgreSQL gagal: " . $e->getMessage() . "<br>Host: " . DB_HOST . ", Port: " . (defined('DB_PORT') ? DB_PORT : 5432) . ", Database: " . DB_NAME);
        }
    } else {
        // MySQL connection (default)
        // Check if MySQLi extension is available
        if (!extension_loaded('mysqli')) {
            die("Error: MySQLi extension tidak tersedia. Silakan install extension ini.");
        }
        
        $port = defined('DB_PORT') ? DB_PORT : 3306;
        $conn = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME, $port);
        
        // Cek koneksi
        if ($conn->connect_error) {
            // Error handling yang lebih informatif
            $error_msg = $conn->connect_error;
            $error_no = $conn->connect_errno;
            
            // Jika di Railway tapi connection gagal, tampilkan instruksi
            if (getenv('RAILWAY_ENVIRONMENT') || getenv('RAILWAY_PROJECT_ID') || file_exists('/.dockerenv')) {
                $setup_url = (defined('BASE_URL') ? BASE_URL : '/') . 'pages/setup_railway.php';
                die("
                    <div style='font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 50px auto; border: 2px solid #dc3545; border-radius: 8px; background: #fff;'>
                        <h2 style='color: #dc3545;'>âŒ Database Connection Gagal</h2>
                        <p><strong>Error:</strong> {$error_msg} (Error Code: {$error_no})</p>
                        <p>Koneksi ke database MySQL gagal. Kemungkinan:</p>
                        <ul>
                            <li>Database service belum ditambahkan di Railway</li>
                            <li>Environment variables belum di-set dengan benar</li>
                            <li>Database service belum di-link ke web service</li>
                        </ul>
                        <p><strong>Solusi:</strong></p>
                        <ol>
                            <li>Buka Railway Dashboard â†’ Tambahkan MySQL Database service</li>
                            <li>Pastikan database di-link ke web service</li>
                            <li>Cek environment variables di Web Service â†’ Variables</li>
                            <li>Restart web service (Redeploy)</li>
                        </ol>
                        <a href='{$setup_url}' style='display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; margin-top: 10px;'>ğŸ“– Lihat Instruksi Setup Lengkap</a>
                    </div>
                ");
            }
            
            // Jika database tidak ada, coba buat
            if ($error_no == 1049) {
                // Database tidak ada, buat dulu
                $conn_temp = new mysqli(DB_HOST, DB_USER, DB_PASS);
                if ($conn_temp->connect_error) {
                    die("Koneksi MySQL gagal: " . $conn_temp->connect_error . "<br>Silakan jalankan setup_database.php terlebih dahulu.");
                }
                $sql = "CREATE DATABASE IF NOT EXISTS `" . DB_NAME . "` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci";
                if ($conn_temp->query($sql)) {
                    $conn_temp->close();
                    // Coba koneksi lagi
                    $conn = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
                    if ($conn->connect_error) {
                        die("Koneksi database gagal setelah dibuat: " . $conn->connect_error);
                    }
                } else {
                    die("Gagal membuat database: " . $conn_temp->error);
                }
            } else {
                die("Koneksi database gagal: " . $conn->connect_error . "<br>Silakan jalankan setup_database.php terlebih dahulu.");
            }
        }
        
        // Set charset UTF-8
        $conn->set_charset("utf8mb4");
    }
    
    return $conn;
}

?>

