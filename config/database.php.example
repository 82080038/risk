<?php
/**
 * Konfigurasi Database - TEMPLATE
 * Risk Assessment Objek Wisata
 * Support untuk Railway.app, Render.com, dan environment variables
 * 
 * INSTRUKSI:
 * 1. Copy file ini menjadi database.php
 * 2. Untuk Railway/Render: Aplikasi akan otomatis membaca dari environment variables
 * 3. Untuk lokal: Isi dengan kredensial database Anda
 */

// Cek Railway MySQL variables (prioritas pertama)
if (getenv('MYSQL_HOST')) {
    // Railway MySQL format
    define('DB_HOST', getenv('MYSQL_HOST'));
    define('DB_PORT', getenv('MYSQL_PORT') ?: 3306);
    define('DB_USER', getenv('MYSQL_USER'));
    define('DB_PASS', getenv('MYSQL_PASSWORD'));
    define('DB_NAME', getenv('MYSQL_DATABASE'));
    define('DB_TYPE', 'mysql');
} elseif (getenv('PGHOST') || getenv('POSTGRES_HOST')) {
    // Railway PostgreSQL format (alternative)
    define('DB_HOST', getenv('PGHOST') ?: getenv('POSTGRES_HOST') ?: 'localhost');
    define('DB_PORT', getenv('PGPORT') ?: getenv('POSTGRES_PORT') ?: 5432);
    define('DB_USER', getenv('PGUSER') ?: getenv('POSTGRES_USER') ?: 'postgres');
    define('DB_PASS', getenv('PGPASSWORD') ?: getenv('POSTGRES_PASSWORD') ?: '');
    define('DB_NAME', getenv('PGDATABASE') ?: getenv('POSTGRES_DB') ?: 'postgres');
    define('DB_TYPE', 'postgresql');
} elseif (getenv('DATABASE_URL')) {
    // Parse DATABASE_URL dari Render (format: postgresql://user:pass@host:port/dbname)
    $url = parse_url(getenv('DATABASE_URL'));
    
    define('DB_HOST', $url['host'] ?? 'localhost');
    define('DB_PORT', $url['port'] ?? 5432); // PostgreSQL default port
    define('DB_USER', $url['user'] ?? '');
    define('DB_PASS', $url['pass'] ?? '');
    define('DB_NAME', ltrim($url['path'] ?? '', '/'));
    define('DB_TYPE', 'postgresql'); // Untuk PostgreSQL di Render
} elseif (getenv('DB_HOST')) {
    // Menggunakan environment variables individual
    define('DB_HOST', getenv('DB_HOST') ?: 'localhost');
    define('DB_PORT', getenv('DB_PORT') ?: 3306); // MySQL default port
    define('DB_USER', getenv('DB_USER') ?: 'root');
    define('DB_PASS', getenv('DB_PASS') ?: '');
    define('DB_NAME', getenv('DB_NAME') ?: 'risk_assessment_db');
    define('DB_TYPE', getenv('DB_TYPE') ?: 'mysql');
} else {
    // Konfigurasi lokal/default
    define('DB_HOST', 'localhost');
    define('DB_USER', 'root');
    define('DB_PASS', '');
    define('DB_NAME', 'risk_assessment_db');
    define('DB_PORT', 3306);
    define('DB_TYPE', 'mysql');
}

// Koneksi database
function getDBConnection() {
    // Cek apakah database sudah didefinisikan
    if (!defined('DB_HOST') || !defined('DB_USER') || !defined('DB_NAME')) {
        die("Error: Konfigurasi database belum lengkap. Pastikan DB_HOST, DB_USER, dan DB_NAME sudah didefinisikan.");
    }
    
    // Untuk PostgreSQL (Render), gunakan PDO
    // Untuk MySQL, gunakan mysqli
    $db_type = defined('DB_TYPE') ? DB_TYPE : 'mysql';
    
    if ($db_type === 'postgresql') {
        // PostgreSQL connection (untuk Railway/Render)
        try {
            // Check if PDO PostgreSQL extension is available
            if (!extension_loaded('pdo_pgsql')) {
                die("Error: PDO PostgreSQL extension (pdo_pgsql) tidak tersedia. Silakan install extension ini.");
            }
            
            $dsn = "pgsql:host=" . DB_HOST . ";port=" . (defined('DB_PORT') ? DB_PORT : 5432) . ";dbname=" . DB_NAME;
            $conn = new PDO($dsn, DB_USER, DB_PASS);
            $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            return $conn;
        } catch (PDOException $e) {
            die("Koneksi PostgreSQL gagal: " . $e->getMessage() . "<br>Host: " . DB_HOST . ", Port: " . (defined('DB_PORT') ? DB_PORT : 5432) . ", Database: " . DB_NAME);
        }
    } else {
        // MySQL connection (default)
        // Check if MySQLi extension is available
        if (!extension_loaded('mysqli')) {
            die("Error: MySQLi extension tidak tersedia. Silakan install extension ini.");
        }
        
        $port = defined('DB_PORT') ? DB_PORT : 3306;
        $conn = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME, $port);
        
        // Cek koneksi
        if ($conn->connect_error) {
            // Jika database tidak ada, coba buat
            if ($conn->connect_errno == 1049) {
                // Database tidak ada, buat dulu
                $conn_temp = new mysqli(DB_HOST, DB_USER, DB_PASS);
                if ($conn_temp->connect_error) {
                    die("Koneksi MySQL gagal: " . $conn_temp->connect_error . "<br>Silakan jalankan setup_database.php terlebih dahulu.");
                }
                $sql = "CREATE DATABASE IF NOT EXISTS `" . DB_NAME . "` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci";
                if ($conn_temp->query($sql)) {
                    $conn_temp->close();
                    // Coba koneksi lagi
                    $conn = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
                    if ($conn->connect_error) {
                        die("Koneksi database gagal setelah dibuat: " . $conn->connect_error);
                    }
                } else {
                    die("Gagal membuat database: " . $conn_temp->error);
                }
            } else {
                die("Koneksi database gagal: " . $conn->connect_error . "<br>Silakan jalankan setup_database.php terlebih dahulu.");
            }
        }
        
        // Set charset UTF-8
        $conn->set_charset("utf8mb4");
    }
    
    return $conn;
}

?>

